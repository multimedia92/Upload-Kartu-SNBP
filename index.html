<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Tugas Siswa</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f6f9;
            margin: 0;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 420px;
        }
        h2 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 25px; 
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555; 
        }
        
        select, input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            box-sizing: border-box;
            background-color: #fff;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        select:focus, input:focus {
            border-color: #4285F4;
            outline: none;
        }
        
        button {
            width: 100%;
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s, transform 0.1s;
            margin-top: 10px;
        }
        button:hover { background-color: #3367D6; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #b0c4de; cursor: not-allowed; }
        
        /* --- STYLE BARU: PROGRESS BAR --- */
        #progressContainer {
            margin-top: 20px;
            display: none; /* Sembunyikan awal */
        }
        .progress-wrapper {
            background-color: #e9ecef;
            border-radius: 10px;
            height: 20px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            background-color: #28a745; /* Warna Hijau */
            height: 100%;
            width: 0%; /* Mulai dari 0 */
            border-radius: 10px;
            transition: width 0.2s ease;
        }
        .progress-text {
            text-align: center;
            font-size: 13px;
            margin-top: 5px;
            color: #555;
            font-weight: bold;
        }

        #status { 
            margin-top: 15px; 
            text-align: center; 
            font-size: 14px; 
            font-weight: 500;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="container">
    <h2>Upload Tugas</h2>
    
    <form id="uploadForm">
        <!-- Input Nama -->
        <div class="form-group">
            <label for="studentName">Pilih Nama Siswa:</label>
            <select id="studentName" required>
                <option value="">⏳ Sedang memuat nama...</option>
            </select>
        </div>

        <!-- Input File -->
        <div class="form-group">
            <label for="fileInput">Pilih File:</label>
            <input type="file" id="fileInput" required>
            <small style="color: #666; display:block; margin-top:5px;">Maksimal 5MB</small>
        </div>
        
        <button type="submit" id="submitBtn" disabled>Upload File</button>
    </form>
    
    <!-- Bagian Progress Bar -->
    <div id="progressContainer">
        <div class="progress-wrapper">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">0%</div>
    </div>
    
    <div id="status"></div>
</div>

<script>
    // ==========================================
    // PASTE URL SCRIPT ANDA DI SINI (Pastikan Deployment Terbaru)
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGXhtJS_Kekfm-nskYv8TTBDcbIFy75mDJ-pgNaVqmMm_IEjlbics2V1qHu0UXohyd/exec"; 

    const selectBox = document.getElementById('studentName');
    const statusDiv = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const fileInput = document.getElementById('fileInput');
    
    // Elemen Progress
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // 1. Load Data Nama
    window.addEventListener('DOMContentLoaded', () => {
        fetch(SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            selectBox.innerHTML = '<option value="">-- Silakan Pilih Nama --</option>';
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    selectBox.appendChild(option);
                });
                submitBtn.disabled = false;
            } else {
                selectBox.innerHTML = '<option value="">Data kosong</option>';
            }
        })
        .catch(error => {
            console.error(error);
            selectBox.innerHTML = '<option value="">Gagal koneksi</option>';
        });
    });

    // 2. Proses Upload dengan Progress Bar
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const file = fileInput.files[0];
        const studentName = selectBox.value;

        // Validasi
        if (!studentName || !file) { alert("Lengkapi data!"); return; }
        if (file.size > 5 * 1024 * 1024) { alert("File terlalu besar!"); return; }

        // Reset UI
        statusDiv.style.display = 'none';
        submitBtn.disabled = true;
        progressContainer.style.display = 'block'; // Tampilkan bar
        progressBar.style.width = '0%';
        progressText.textContent = 'Membaca file...';

        const reader = new FileReader();
        reader.readAsDataURL(file);
        
        reader.onload = function(e) {
            const rawLog = reader.result.split(',')[1];
            
            // Siapkan Data
            const formData = new FormData();
            formData.append('data', e.target.result);
            formData.append('name', file.name);
            formData.append('mimetype', file.type);
            formData.append('studentName', studentName);

            // Ganti FETCH dengan XMLHttpRequest (AJAX) untuk memantau progress
            const xhr = new XMLHttpRequest();
            xhr.open("POST", SCRIPT_URL);

            // --- EVENT SAAT PROGRESS BERJALAN ---
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    
                    progressBar.style.width = percentComplete + '%';
                    progressText.textContent = percentComplete + '% Uploading...';
                    
                    if(percentComplete === 100){
                        progressText.textContent = 'Mengirim ke Drive... (Mohon Tunggu)';
                        progressBar.style.backgroundColor = '#007bff'; // Ganti warna jadi biru saat processing
                    }
                }
            };

            // --- EVENT SAAT SELESAI ---
            xhr.onload = function() {
                submitBtn.disabled = false;
                progressContainer.style.display = 'none'; // Sembunyikan bar
                statusDiv.style.display = 'block';

                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            statusDiv.innerHTML = "✅ " + response.message;
                            statusDiv.className = "success";
                            // Reset Form
                            fileInput.value = "";
                            selectBox.value = "";
                        } else {
                            throw new Error(response.message);
                        }
                    } catch (err) {
                        statusDiv.innerHTML = "⚠️ Terupload, tapi respon script error.";
                        statusDiv.className = "success"; // Biasanya tetap sukses masuk drive
                        console.log(xhr.responseText);
                    }
                } else {
                    statusDiv.innerHTML = "❌ Gagal Terhubung Server.";
                    statusDiv.className = "error";
                }
            };

            // --- EVENT SAAT ERROR ---
            xhr.onerror = function() {
                submitBtn.disabled = false;
                progressContainer.style.display = 'none';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = "❌ Terjadi kesalahan jaringan.";
                statusDiv.className = "error";
            };

            // Kirim Data
            // Kita perlu mengubah formData menjadi URLSearchParams agar terbaca 'e.parameter' di GAS
            const params = new URLSearchParams();
            for(const pair of formData.entries()){
                params.append(pair[0], pair[1]);
            }
            
            xhr.send(params);
        };
    });
</script>

</body>
</html>
